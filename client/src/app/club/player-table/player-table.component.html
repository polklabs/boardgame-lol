<div style="height: calc(100vh - 103px)">
  <p-table
    [value]="(players$ | async) ?? []"
    dataKey="PlayerId"
    [scrollable]="true"
    scrollHeight="flex"
    styleClass="p-datatable-striped p-datatable-sm"
    sortField="Wins.length"
    [sortOrder]="-1"
    [tableStyle]="{ 'min-width': '50rem' }"
    [expandedRowKeys]="expandedRows">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 0"></th>
        <th *ngFor="let column of playerColumns" [pSortableColumn]="column.sort ? column.field : undefined">
          {{ column.name }}
          <p-sortIcon *ngIf="column.sort" [field]="column.field" />
        </th>
        <th *ngIf="canEdit" class="edit-header">Edit</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-player let-expanded="expanded">
      <tr>
        <td>
          <p-button
            type="button"
            pRipple
            [pRowToggler]="player"
            [text]="true"
            [rounded]="true"
            [plain]="true"
            [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
        </td>
        <td>
          {{ player.Name }}
          <i *ngIf="stats?.Champions?.includes(player)" class="pi pi-crown" style="color: gold"></i>
        </td>
        <td>
          <span>{{ player.Wins.length | hide: '0' | number: '1.0-0' }}</span>
          <div
            *ngIf="player.Wins.length > 0"
            class="bar-percent"
            [ngStyle]="{ width: (player.Wins.length / (stats?.MaxPlayerWins ?? 1)) * 100 + '%' }"></div>
        </td>
        <td>{{ player.BestGames | array: 'Name' }}</td>
        <td>{{ player.BestGameWins | hide: '0' | number: '1.0-0' }}</td>
        <td *ngIf="canEdit">
          <p-button (click)="playerEdit.emit(player)" icon="pi pi-pencil" [rounded]="true" [text]="true"></p-button>
        </td>
      </tr>
    </ng-template>

    <!-- Row Expansion -->
    <ng-template pTemplate="rowexpansion" let-player>
      <tr *ngFor="let playerGame of player.Games; let index = index" class="expansion-row">
        <td></td>
        <td></td>
        <td></td>
        <td>
          <div class="flex gap-8 justify-content-space-between">
            <span>{{ playerGame.Game.BoardGame.Name }}</span>
            <span *ngIf="showScore(playerGame.Game)">{{ playerGame.Points | number: '1.0-3' }}</span>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
